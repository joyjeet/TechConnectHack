# Frontend - React + TypeScript + Vite

**AI Assistance**: See `.github/skills/writing-typescript-code/SKILL.md` for coding patterns.

## Overview

React 19 single-page application with:
- TypeScript for type safety
- Vite for fast development (HMR) and optimized builds
- MSAL.js for Microsoft Entra ID authentication (PKCE flow)
- Server-Sent Events (SSE) for real-time chat streaming
- CSS Modules for scoped styling

## Key Features

- **Authentication**: MSAL.js with silent token refresh + popup fallback
- **Chat Streaming**: SSE-based streaming with cancellation support
- **File Uploads**: Image attachments with client-side validation
- **Citations**: Inline citation markers with footnote navigation
- **Accessibility**: ARIA live regions, keyboard navigation, focus management
- **State Management**: Centralized Context + useReducer pattern

## Project Structure

```
frontend/src/
â”œâ”€â”€ App.tsx                      # Root with MsalProvider
â”œâ”€â”€ main.tsx                     # Entry point
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ AgentPreview.tsx         # Container (state â†’ ChatInterface)
â”‚   â”œâ”€â”€ ChatInterface.tsx        # Controlled chat UI
â”‚   â””â”€â”€ chat/                    # Chat subcomponents
â”‚       â”œâ”€â”€ AssistantMessage.tsx # Streaming message + citations
â”‚       â”œâ”€â”€ UserMessage.tsx      # User message + image previews
â”‚       â”œâ”€â”€ ChatInput.tsx        # Input + file upload + cancel
â”‚       â””â”€â”€ CitationMarker.tsx   # Inline citation badge
â”œâ”€â”€ services/
â”‚   â””â”€â”€ chatService.ts           # SSE streaming + API calls
â”œâ”€â”€ contexts/
â”‚   â””â”€â”€ AppContext.tsx           # Centralized state (useReducer)
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useAuth.ts               # MSAL token acquisition
â”‚   â””â”€â”€ useAppState.ts           # State access hook
â”œâ”€â”€ reducers/
â”‚   â””â”€â”€ appReducer.ts            # State transitions
â”œâ”€â”€ config/
â”‚   â””â”€â”€ authConfig.ts            # MSAL configuration
â”œâ”€â”€ types/                       # TypeScript interfaces
â””â”€â”€ utils/                       # Helpers (citations, files, etc.)
```

## Running Locally

### Prerequisites
- Node.js 18+
- `.env.local` file generated (run `azd up` first)

### Start

**Option 1: VS Code task (recommended)**
- Run task `Frontend: React Vite` - dependencies are installed automatically

**Option 2: Manual**
```powershell
cd frontend
npm install --legacy-peer-deps
npm run dev
```

Frontend runs at http://localhost:5173 with Hot Module Replacement (HMR).

### Configuration

`.env.local` file (auto-generated by `azd up`):
```
VITE_ENTRA_SPA_CLIENT_ID=...
VITE_ENTRA_TENANT_ID=...
```

**CRITICAL**: Environment variables are replaced at build time. Access them at module level only:
```typescript
// âœ… Correct - module level
const clientId = import.meta.env.VITE_ENTRA_SPA_CLIENT_ID;

// âŒ Wrong - inside function (won't work after build)
function getClientId() {
  return import.meta.env.VITE_ENTRA_SPA_CLIENT_ID;
}
```

## Development Tips

- **Hot reload**: Vite HMR updates browser instantly on save
- **React 19**: Use `--legacy-peer-deps` with npm install
- **State debugging**: Console shows `ğŸ”„ ACTION_TYPE` for each state change (dev only)
- **CORS**: Backend allows `http://localhost:5173` in dev mode

## Building

```powershell
npm run build      # Production build â†’ dist/
npm run preview    # Preview production build locally
```

Production builds are created in Docker multi-stage builds and served from ASP.NET Core's `wwwroot`.

## Key Dependencies

| Package | Version | Purpose |
|---------|---------|---------|
| react | 19.x | UI framework |
| @azure/msal-react | 3.x | Entra ID authentication |
| @azure/msal-browser | 4.x | MSAL.js browser library |
| @fluentui/react-components | 9.x | Fluent UI components |
| vite | 6.x | Build tool + dev server |

## Component Architecture

| Component | Role | Pattern |
|-----------|------|---------|
| `AgentPreview` | Container | Wires state to controlled component |
| `ChatInterface` | Presentation | Stateless, receives props + callbacks |
| `ChatInput` | Controlled input | Manages local input state, calls parent handlers |
| `AssistantMessage` | Memoized | Renders streaming text + citations |

## State Flow

```
User Action
  â†’ dispatch(action)
  â†’ appReducer (pure function)
  â†’ new state
  â†’ React re-render
  â†’ UI update
```

**Action types**: `CHAT_SEND_MESSAGE` â†’ `CHAT_START_STREAM` â†’ `CHAT_STREAM_CHUNK` (Ã—N) â†’ `CHAT_STREAM_COMPLETE`

## Troubleshooting

| Issue | Solution |
|-------|----------|
| Module not found | Run `npm install --legacy-peer-deps` |
| Auth popup blocked | Allow popups for localhost in browser |
| Stale cache | Delete `node_modules/.vite` and restart |
| HMR not working | Check Vite terminal for errors |
| 401 on API calls | Verify `.env.local` has correct client ID |

For AI-assisted development, see `.github/skills/writing-typescript-code/SKILL.md` and `.github/skills/implementing-chat-streaming/SKILL.md`.
